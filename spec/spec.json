{
  "project": "terminal-uiux-fixes",
  "version": "1.0.0",
  "status": "complete",
  "last_updated": "2026-01-07T16:00:00Z",
  "objective": "All 6 terminal rendering/input issues are root-caused with clear, implementable fixes that don't introduce regressions",
  "overview": {
    "summary": "Comprehensive investigation and fix specification for terminal UI/UX bugs including cursor visibility, multi-pane corruption, rendering stacking, status bar flickering, input duplication, and status bar consolidation.",
    "current_state": "Terminal exhibits multiple rendering and input handling bugs: invisible cursor, cross-pane corruption when switching focus, tmux status bar stacking 3-4x, spontaneous status bar flickering, 3x input duplication in grid view, and redundant bottom status bar.",
    "desired_state": "Terminal with high-contrast visible cursor, isolated pane rendering, clean single-render status bars, event-driven updates (no flicker), single-destination input routing, and minimal top-bar-only UI with hover-accessible session info."
  },
  "gaps": [
    {
      "id": "gap-1",
      "description": "Cursor accent color matches background",
      "current": "cursorAccent: '#0a0e14' (same as background)",
      "needed": "cursorAccent: '#ffffff' (white for visibility)"
    },
    {
      "id": "gap-2",
      "description": "Invisible terminals still process WebSocket messages",
      "current": "All Terminal components mount and receive WS messages regardless of visibility",
      "needed": "Pause WS message processing when terminal is invisible (keep connection)"
    },
    {
      "id": "gap-3",
      "description": "Multiple overlapping resize handlers cause race conditions",
      "current": "window.resize (immediate) + ResizeObserver (150ms debounce) + double fit() on init",
      "needed": "Single ResizeObserver handler, single fit() call, proper debouncing"
    },
    {
      "id": "gap-4",
      "description": "Polling causes cascading cache invalidations",
      "current": "30s refetchInterval on sessions + 500ms Claude polling invalidates ALL sessions",
      "needed": "Event-driven refetch only (on user actions), no polling intervals"
    },
    {
      "id": "gap-5",
      "description": "XTerm onData fires for all visible terminals",
      "current": "No focus check - all mounted terminals send input to their WebSocket",
      "needed": "Focus guard in onData handler - only send if terminal is focused"
    },
    {
      "id": "gap-6",
      "description": "Tmux status bar renders and stacks",
      "current": "Tmux status bar enabled, renders at bottom, stacks during resize races",
      "needed": "Disable tmux status bar entirely via config, add top-bar icon with hover tooltip"
    }
  ],
  "requirements": {
    "goals": [
      {
        "goal": "Cursor clearly visible in all contexts",
        "criteria": [
          "Cursor accent is white (#ffffff)",
          "Block cursor has visible text inside",
          "Works with phosphor green theme"
        ],
        "priority": "must"
      },
      {
        "goal": "Grid view switching causes zero corruption",
        "criteria": [
          "Invisible terminals pause WS message processing",
          "Terminal content preserved when switching focus",
          "No content bleeding between panes"
        ],
        "priority": "must"
      },
      {
        "goal": "No duplicate/stacked rendering artifacts",
        "criteria": [
          "Single fit() call per resize event",
          "ResizeObserver is sole resize trigger",
          "Remove duplicate 100ms delayed fit()",
          "Remove window.resize listener"
        ],
        "priority": "must"
      },
      {
        "goal": "Status bar remains stable - no flickering",
        "criteria": [
          "Remove 30s refetchInterval from sessions query",
          "Remove 500ms Claude polling (make startup await-based)",
          "Only refetch on explicit user actions"
        ],
        "priority": "must"
      },
      {
        "goal": "Input goes only to focused terminal",
        "criteria": [
          "Add focus tracking to Terminal component",
          "Guard onData handler with focus check",
          "Single keystroke = single send to one terminal"
        ],
        "priority": "must"
      },
      {
        "goal": "Minimal top bar with accessible session info",
        "criteria": [
          "Disable tmux status bar (set -g status off)",
          "Add info icon to top bar",
          "Icon hover shows session ID + timestamp tooltip",
          "Click copies session info to clipboard"
        ],
        "priority": "must"
      }
    ]
  },
  "decisions": [
    {
      "id": "dec-1",
      "decision": "Pause WS processing for invisible terminals (not disconnect)",
      "rationale": "Keeps connection alive for fast switching (~0ms) vs reconnect latency (~100-300ms). Buffer accumulates but is discarded or processed on visibility change.",
      "alternatives_considered": ["Full disconnect", "Lazy mount"]
    },
    {
      "id": "dec-2",
      "decision": "Use ResizeObserver only, remove window.resize",
      "rationale": "ResizeObserver already catches all container changes. Window.resize is redundant and causes race conditions with debounced ResizeObserver.",
      "alternatives_considered": ["Keep both + batch", "Keep current"]
    },
    {
      "id": "dec-3",
      "decision": "Event-driven refetch, no polling intervals",
      "rationale": "30s polling causes flickering even when idle. React Query already refetches on window focus. User actions (create, delete, mode switch) trigger explicit invalidations.",
      "alternatives_considered": ["Increase interval to 2-5min", "Scoped invalidation"]
    },
    {
      "id": "dec-4",
      "decision": "Focus guard in onData handler",
      "rationale": "Single-point fix in Terminal.tsx:197. Check if terminal is focused before sending to WebSocket. Simpler than architectural slot deduplication.",
      "alternatives_considered": ["Prevent duplicate slots in GridLayout", "Both guards"]
    },
    {
      "id": "dec-5",
      "decision": "Disable tmux status bar via config",
      "rationale": "set -g status off removes all status bar rendering. Cleaner than viewport hacks. No stacking possible if bar doesn't exist.",
      "alternatives_considered": ["Hide via row calculation"]
    },
    {
      "id": "dec-6",
      "decision": "Top bar info icon with hover tooltip + click-to-copy",
      "rationale": "Keeps top bar minimal while preserving session context access. Useful for debugging/testing. Timestamp included for session age visibility.",
      "alternatives_considered": ["No identifier", "Always-visible session ID"]
    }
  ],
  "implementation": {
    "phases": [
      {
        "phase": 1,
        "name": "Cursor Fix",
        "files": [
          "frontend/lib/constants/terminal.ts"
        ],
        "tasks": [
          "Change cursorAccent from '#0a0e14' to '#ffffff' (line 50)"
        ]
      },
      {
        "phase": 2,
        "name": "Resize Consolidation",
        "files": [
          "frontend/components/Terminal.tsx"
        ],
        "tasks": [
          "Remove window.resize event listener (line 207)",
          "Remove 100ms delayed fit() call (lines 190-194)",
          "Keep single ResizeObserver with proper debounce"
        ]
      },
      {
        "phase": 3,
        "name": "Focus-Based Input Guard",
        "files": [
          "frontend/components/Terminal.tsx"
        ],
        "tasks": [
          "Add isFocused state/ref to Terminal component",
          "Track focus via xterm.js textarea focus events",
          "Guard onData handler: only send if isFocused"
        ]
      },
      {
        "phase": 4,
        "name": "Invisible Terminal Pause",
        "files": [
          "frontend/components/Terminal.tsx",
          "frontend/lib/hooks/use-terminal-websocket.ts"
        ],
        "tasks": [
          "Add isVisible prop to Terminal component",
          "Pass visibility state from TerminalTabs (based on activeSessionId)",
          "In onMessage callback, skip write() if not visible",
          "Optionally: flush accumulated buffer on visibility change"
        ]
      },
      {
        "phase": 5,
        "name": "Event-Driven Refetch",
        "files": [
          "frontend/lib/hooks/use-terminal-sessions.ts",
          "frontend/lib/hooks/use-claude-polling.ts"
        ],
        "tasks": [
          "Remove refetchInterval: 30000 from sessions query (line 158)",
          "Convert Claude polling to promise-based await (startClaudeAndWait)",
          "Keep explicit invalidations on user actions (create, delete, mode switch)"
        ]
      },
      {
        "phase": 6,
        "name": "Tmux Status Bar Removal",
        "files": [
          "terminal/utils/tmux.py"
        ],
        "tasks": [
          "Add 'set -g status off' to tmux session creation",
          "Verify existing sessions can be updated or need recreation"
        ]
      },
      {
        "phase": 7,
        "name": "Top Bar Session Info Icon",
        "files": [
          "frontend/components/TabBar.tsx",
          "frontend/components/SessionInfoIcon.tsx (new)"
        ],
        "tasks": [
          "Create SessionInfoIcon component with tooltip",
          "Tooltip shows: session ID, mode (shell/claude), timestamp",
          "Click handler copies info to clipboard",
          "Add icon to TabBar right side"
        ]
      }
    ]
  },
  "files_to_modify": [
    {
      "path": "frontend/lib/constants/terminal.ts",
      "action": "edit",
      "description": "Change cursorAccent to #ffffff"
    },
    {
      "path": "frontend/components/Terminal.tsx",
      "action": "edit",
      "description": "Remove window.resize listener, remove delayed fit(), add focus tracking, add visibility-based message handling"
    },
    {
      "path": "frontend/lib/hooks/use-terminal-websocket.ts",
      "action": "edit",
      "description": "Add visibility check to onMessage callback"
    },
    {
      "path": "frontend/lib/hooks/use-terminal-sessions.ts",
      "action": "edit",
      "description": "Remove refetchInterval: 30000"
    },
    {
      "path": "frontend/lib/hooks/use-claude-polling.ts",
      "action": "edit",
      "description": "Convert interval polling to promise-based await"
    },
    {
      "path": "terminal/utils/tmux.py",
      "action": "edit",
      "description": "Add set -g status off to session creation"
    },
    {
      "path": "frontend/components/TabBar.tsx",
      "action": "edit",
      "description": "Add SessionInfoIcon to right side"
    }
  ],
  "files_to_create": [
    {
      "path": "frontend/components/SessionInfoIcon.tsx",
      "description": "Info icon with hover tooltip (session + timestamp) and click-to-copy"
    }
  ],
  "dependencies": {
    "existing": [
      "@xterm/xterm",
      "@xterm/addon-fit",
      "react-query"
    ],
    "new": []
  },
  "recommended_next_steps": [
    "Run /task_it terminal-uiux-fixes to generate SummitFlow task with subtasks",
    "Test cursor visibility after Phase 1",
    "Test input duplication in 2x2 grid after Phase 3",
    "Verify no flickering after Phase 5 with 60+ second idle observation"
  ],
  "discovery_meta": {
    "phases_completed": ["detection", "discovery", "interview", "specification"],
    "questions_asked": 6,
    "explore_agents_used": 5,
    "files_analyzed": [
      "frontend/components/Terminal.tsx",
      "frontend/components/TerminalTabs.tsx",
      "frontend/components/GridLayout.tsx",
      "frontend/lib/constants/terminal.ts",
      "frontend/lib/hooks/use-terminal-websocket.ts",
      "frontend/lib/hooks/use-terminal-sessions.ts",
      "frontend/lib/hooks/use-claude-polling.ts",
      "frontend/lib/hooks/use-terminal-tabs-state.ts",
      "terminal/utils/tmux.py",
      "terminal/api/terminal.py"
    ],
    "root_causes_identified": {
      "cursor": "cursorAccent #0a0e14 matches background",
      "corruption": "Invisible terminals still process WS messages",
      "stacking": "Multiple fit() calls + racing resize handlers",
      "flickering": "30s refetch + 500ms Claude polling",
      "input_dup": "No focus guard on onData, all instances send"
    }
  }
}
