#!/usr/bin/env bash
# tclaude - Claude Code local session manager
#
# Option B Architecture: Completely independent from web terminal.
# Uses local tmux sessions (claude-{project}), no API sync.
#
# Usage:
#   tclaude              # Interactive project selector
#   tclaude <project>    # Direct attach to project
#   tclaude -l           # List active claude sessions

set -euo pipefail

# ── Helpers ──────────────────────────────────────────────────────────────────

# Discover projects with git + project indicators
discover_projects() {
  for dir in "$HOME"/*/; do
    [ -d "$dir/.git" ] || continue
    if [ -f "$dir/CLAUDE.md" ] || [ -d "$dir/.claude" ] || \
       [ -d "$dir/.gemini" ] || [ -d "$dir/.codex" ] || \
       [ -f "$dir/package.json" ] || [ -f "$dir/pyproject.toml" ] || \
       [ -f "$dir/Cargo.toml" ] || [ -f "$dir/go.mod" ] || \
       [ -f "$dir/composer.json" ] || [ -f "$dir/Gemfile" ] || \
       [ -f "$dir/Makefile" ] || [ -f "$dir/CMakeLists.txt" ]; then
      basename "$dir"
    fi
  done
}

# List active claude sessions
list_sessions() {
  echo "Active Claude sessions:"
  tmux list-sessions -F "#{session_name}" 2>/dev/null | grep "^claude-" | sed 's/^claude-/  /' || echo "  (none)"
}

# Attach or switch to tmux session
attach_session() {
  local session_name="$1"
  if [ -n "${TMUX:-}" ]; then
    tmux switch-client -t "$session_name"
  else
    tmux attach -t "$session_name"
  fi
}

# Create new tmux session with Claude
create_session() {
  local session_name="$1"
  local project_dir="$2"

  if [ -n "${TMUX:-}" ]; then
    tmux new-session -d -s "$session_name" -c "$project_dir" "claude --model opusplan --dangerously-skip-permissions"
    tmux switch-client -t "$session_name"
  else
    tmux new -s "$session_name" -c "$project_dir" "claude --model opusplan --dangerously-skip-permissions"
  fi
}

# ── Main ─────────────────────────────────────────────────────────────────────

main() {
  local selected="${1:-}"

  # Handle -l flag
  if [ "$selected" = "-l" ]; then
    list_sessions
    exit 0
  fi

  # Discover projects
  local projects=()
  while IFS= read -r proj; do
    [ -n "$proj" ] && projects+=("$proj")
  done < <(discover_projects)

  if [ ${#projects[@]} -eq 0 ]; then
    echo "No projects found (need .git + project indicator)" >&2
    exit 1
  fi

  # If no argument, use fzf to select
  if [ -z "$selected" ]; then
    # Build display list with session markers
    local display=()
    for proj in "${projects[@]}"; do
      if tmux has-session -t "claude-$proj" 2>/dev/null; then
        display+=("$proj [active]")
      else
        display+=("$proj")
      fi
    done

    selected=$(printf '%s\n' "${display[@]}" | fzf --height=10 --reverse --prompt="Select project: ") || true

    if [ -z "$selected" ]; then
      echo "No project selected" >&2
      exit 1
    fi

    # Strip marker if present
    selected="${selected% \[active\]}"
  fi

  # Validate project exists
  local project_dir="$HOME/$selected"
  if [ ! -d "$project_dir" ]; then
    echo "Project '$selected' not found" >&2
    exit 1
  fi

  local session_name="claude-$selected"

  # Attach if exists, create if not
  if tmux has-session -t "$session_name" 2>/dev/null; then
    echo "Attaching to $session_name..."
    attach_session "$session_name"
  else
    echo "Starting Claude in $selected..."
    create_session "$session_name" "$project_dir"
  fi
}

main "$@"
