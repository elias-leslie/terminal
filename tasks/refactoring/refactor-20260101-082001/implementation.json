{
  "meta": {
    "title": "Terminal Project Refactor - Session 2",
    "created": "2026-01-01",
    "project": "terminal",
    "session_dir": "/home/kasadis/terminal/tasks/refactoring/refactor-20260101-082001",
    "total_tasks": 18,
    "summary": {
      "high_priority_issues": 5,
      "medium_priority_issues": 10,
      "low_priority_issues": 3,
      "security_critical": 0
    }
  },
  "phases": [
    {
      "id": 1,
      "name": "Backend Consistency",
      "goal": "Standardize patterns in storage and API layers",
      "tasks": [
        {
          "id": "1.1",
          "tier": 1,
          "model": "haiku",
          "parallelizable": true,
          "description": "Extract SESSION_MODES constant in lifecycle.py",
          "category": "magic_values",
          "severity": "low",
          "passes": true,
          "files_affected": ["terminal/services/lifecycle.py"],
          "steps": [
            "Read terminal/services/lifecycle.py lines 248 and 320",
            "Add SESSION_MODES = ['shell', 'claude'] constant at module level after imports",
            "Replace hardcoded ['shell', 'claude'] at line 248 with SESSION_MODES",
            "Replace hardcoded ['shell', 'claude'] at line 320 with SESSION_MODES",
            "Run python -c 'from terminal.services import lifecycle' to verify import"
          ],
          "verification": "grep 'SESSION_MODES' terminal/services/lifecycle.py"
        },
        {
          "id": "1.2",
          "tier": 2,
          "model": "sonnet",
          "parallelizable": true,
          "description": "Standardize SQL construction in storage/terminal.py",
          "category": "sql_consistency",
          "severity": "medium",
          "passes": true,
          "files_affected": ["terminal/storage/terminal.py"],
          "steps": [
            "Read terminal/storage/terminal.py lines 42-49 (list_sessions ORDER BY)",
            "Import sql from psycopg if not already imported",
            "Refactor list_sessions to use sql.SQL for ORDER BY clause instead of f-string",
            "Verify pattern matches update_session (lines 146-153)",
            "Run python -c 'from terminal.storage import terminal; terminal.list_sessions()' to test"
          ],
          "verification": "grep -v 'f\".*ORDER BY' terminal/storage/terminal.py"
        },
        {
          "id": "1.3",
          "tier": 2,
          "model": "sonnet",
          "parallelizable": false,
          "description": "Add logging for silent OSError in _read_output",
          "category": "error_handling",
          "severity": "medium",
          "passes": true,
          "files_affected": ["terminal/api/terminal.py"],
          "steps": [
            "Read terminal/api/terminal.py lines 380-390 (_read_output OSError handling)",
            "Distinguish between OSError with errno.EIO (expected EOF) and other errors",
            "Log unexpected OSErrors with logger.warning including error details",
            "Keep silent handling only for expected EOF conditions"
          ],
          "verification": "grep -A3 'except OSError' terminal/api/terminal.py | grep 'logger'"
        }
      ]
    },
    {
      "id": 2,
      "name": "Frontend Utility Extraction",
      "goal": "Extract shared utilities and reduce duplication",
      "tasks": [
        {
          "id": "2.1",
          "tier": 1,
          "model": "haiku",
          "parallelizable": true,
          "description": "Extract isMobileDevice to shared utility",
          "category": "dry_violation",
          "severity": "low",
          "passes": true,
          "files_affected": ["frontend/components/Terminal.tsx", "frontend/lib/utils/device.ts"],
          "steps": [
            "Create frontend/lib/utils/device.ts",
            "Move isMobileDevice function from Terminal.tsx lines 42-47",
            "Export function with same signature",
            "Update Terminal.tsx import to use new utility",
            "Update use-terminal-scrolling.ts if it references this function",
            "Run npm run build to verify"
          ],
          "verification": "test -f frontend/lib/utils/device.ts && grep 'isMobileDevice' frontend/lib/utils/device.ts"
        },
        {
          "id": "2.2",
          "tier": 2,
          "model": "sonnet",
          "parallelizable": true,
          "description": "Extract useHoverStyle hook for button hover effects",
          "category": "dry_violation",
          "severity": "medium",
          "passes": true,
          "files_affected": ["frontend/lib/hooks/use-hover-style.ts", "frontend/components/TerminalManagerModal.tsx"],
          "steps": [
            "Create frontend/lib/hooks/use-hover-style.ts",
            "Implement useHoverStyle({hoverBg, defaultBg, hoverColor, defaultColor}) returning {onMouseEnter, onMouseLeave, style, setHovered}",
            "Update TerminalManagerModal.tsx to use hook for close button (lines 150-154)",
            "Update cancel button (lines 214-218)",
            "Update apply button (lines 244-248)",
            "Run npm run build to verify"
          ],
          "verification": "test -f frontend/lib/hooks/use-hover-style.ts && npm run build"
        }
      ]
    },
    {
      "id": 3,
      "name": "TerminalTabs Component Decomposition",
      "goal": "Break down 971-line God Component into focused sub-components",
      "tasks": [
        {
          "id": "3.1",
          "tier": 2,
          "model": "sonnet",
          "parallelizable": false,
          "description": "Extract useTabEditing hook from TerminalTabs",
          "category": "hook_extraction",
          "severity": "medium",
          "passes": true,
          "files_affected": ["frontend/components/TerminalTabs.tsx", "frontend/lib/hooks/use-tab-editing.ts"],
          "steps": [
            "Read TerminalTabs.tsx lines 235-270 for editing state and handlers",
            "Create frontend/lib/hooks/use-tab-editing.ts",
            "Extract editingId, editValue, editInputRef state",
            "Extract handleStartEdit, handleSaveEdit, handleCancelEdit, handleEditKeyDown",
            "Export {editingId, editValue, editInputRef, startEdit, saveEdit, cancelEdit, handleKeyDown}",
            "Update TerminalTabs.tsx to use hook",
            "Run npm run build"
          ],
          "verification": "test -f frontend/lib/hooks/use-tab-editing.ts && npm run build"
        },
        {
          "id": "3.2",
          "tier": 2,
          "model": "sonnet",
          "parallelizable": false,
          "description": "Extract createProjectSession utility function",
          "category": "dry_violation",
          "severity": "medium",
          "passes": true,
          "files_affected": ["frontend/components/TerminalTabs.tsx", "frontend/lib/utils/session.ts"],
          "steps": [
            "Read TerminalTabs.tsx lines 280-304 (handleProjectTabClick session creation)",
            "Read lines 327-346 (handleProjectModeChange session creation)",
            "Create frontend/lib/utils/session.ts",
            "Extract createProjectSession(projectId, mode, workingDir) that handles fetch, error, returns session",
            "Update both handlers to use utility",
            "Run npm run build"
          ],
          "verification": "test -f frontend/lib/utils/session.ts && grep 'createProjectSession' frontend/lib/utils/session.ts"
        },
        {
          "id": "3.3",
          "tier": 3,
          "model": "opus",
          "parallelizable": false,
          "description": "Extract TabBar sub-component from TerminalTabs",
          "category": "component_size",
          "severity": "high",
          "passes": true,
          "files_affected": ["frontend/components/TerminalTabs.tsx", "frontend/components/TabBar.tsx"],
          "steps": [
            "Read TerminalTabs.tsx lines 516-620 (tab rendering section)",
            "Create frontend/components/TabBar.tsx",
            "Extract tab header rendering with project tabs and adhoc tabs",
            "Define props: projects, activeProject, activeTerminal, handlers, refs, editingState",
            "Update TerminalTabs.tsx to use TabBar component",
            "Run npm run build"
          ],
          "verification": "test -f frontend/components/TabBar.tsx && npm run build"
        },
        {
          "id": "3.4",
          "tier": 3,
          "model": "opus",
          "parallelizable": false,
          "description": "Extract useProjectModeSwitch hook",
          "category": "business_logic",
          "severity": "high",
          "passes": true,
          "files_affected": ["frontend/components/TerminalTabs.tsx", "frontend/lib/hooks/use-project-mode-switch.ts"],
          "steps": [
            "Read TerminalTabs.tsx lines 310-378 (handleProjectModeChange - 68 lines)",
            "Create frontend/lib/hooks/use-project-mode-switch.ts",
            "Extract 6-step orchestration: mode switch, session creation, Claude check, polling, navigation, scroll",
            "Export switchProjectMode(projectId, mode) with internal state management",
            "Update TerminalTabs.tsx to use hook",
            "Run npm run build"
          ],
          "verification": "test -f frontend/lib/hooks/use-project-mode-switch.ts && npm run build"
        }
      ]
    },
    {
      "id": 4,
      "name": "API Layer Cleanup",
      "goal": "Split oversized WebSocket handler into focused functions",
      "tasks": [
        {
          "id": "4.1",
          "tier": 2,
          "model": "sonnet",
          "parallelizable": false,
          "description": "Extract _handle_websocket_message from terminal_websocket",
          "category": "function_size",
          "severity": "medium",
          "passes": true,
          "files_affected": ["terminal/api/terminal.py"],
          "steps": [
            "Read terminal/api/terminal.py lines 258-295 (input handling)",
            "Create _handle_websocket_message(message, master_fd, resize_callback) function",
            "Handle message type detection, resize JSON parsing, and text forwarding",
            "Use early returns for clarity",
            "Update terminal_websocket to call helper",
            "Run python -c 'from terminal.api import terminal'"
          ],
          "verification": "grep 'def _handle_websocket_message' terminal/api/terminal.py"
        },
        {
          "id": "4.2",
          "tier": 2,
          "model": "sonnet",
          "parallelizable": false,
          "description": "Extract _validate_and_prepare_session from terminal_websocket",
          "category": "separation_of_concerns",
          "severity": "medium",
          "passes": true,
          "files_affected": ["terminal/api/terminal.py"],
          "steps": [
            "Read terminal/api/terminal.py lines 206-244 (session initialization)",
            "Create _validate_and_prepare_session(session_id) -> tuple[Session, TargetSession]",
            "Handle session lookup, validation, alive check, tmux target detection",
            "Raise appropriate WebSocketException on failures",
            "Update terminal_websocket to use helper",
            "Run python -c 'from terminal.api import terminal'"
          ],
          "verification": "grep 'def _validate_and_prepare_session' terminal/api/terminal.py"
        }
      ]
    },
    {
      "id": 5,
      "name": "Backend DRY Improvements",
      "goal": "Reduce duplicate patterns in Python code",
      "tasks": [
        {
          "id": "5.1",
          "tier": 2,
          "model": "sonnet",
          "parallelizable": false,
          "description": "Extract _resurrect_dead_session from create_session",
          "category": "function_size",
          "severity": "medium",
          "passes": true,
          "files_affected": ["terminal/services/lifecycle.py"],
          "steps": [
            "Read terminal/services/lifecycle.py lines 59-151 (create_session)",
            "Identify resurrection path (lines 85-119)",
            "Create _resurrect_dead_session(dead_session, mode, name, working_dir) helper",
            "Handle delete old, create new, start tmux, mark alive",
            "Update create_session to delegate to helper",
            "Run python -c 'from terminal.services import lifecycle'"
          ],
          "verification": "grep 'def _resurrect_dead_session' terminal/services/lifecycle.py"
        },
        {
          "id": "5.2",
          "tier": 2,
          "model": "sonnet",
          "parallelizable": false,
          "description": "Standardize error rollback in lifecycle.py",
          "category": "inconsistent_error_handling",
          "severity": "medium",
          "passes": true,
          "files_affected": ["terminal/services/lifecycle.py"],
          "steps": [
            "Read lines 106-110 (resurrection rollback - marks dead)",
            "Read lines 134-141 (new creation rollback - deletes record)",
            "Standardize: resurrection uses mark_dead, new creation uses delete_session",
            "Add consistent logging for both rollback paths",
            "Document the rollback strategy in function docstring"
          ],
          "verification": "grep -A5 'tmux.*fail' terminal/services/lifecycle.py | grep -E 'mark_dead|delete_session'"
        }
      ]
    },
    {
      "id": 6,
      "name": "Final Verification",
      "goal": "Ensure all changes work together",
      "tasks": [
        {
          "id": "6.1",
          "tier": 1,
          "model": "haiku",
          "parallelizable": false,
          "description": "Run full build and verify services",
          "category": "verification",
          "severity": "high",
          "passes": false,
          "files_affected": [],
          "steps": [
            "cd ~/terminal/frontend && npm run build",
            "cd ~/terminal && source .venv/bin/activate && python -c 'from terminal.api import terminal; from terminal.services import lifecycle; from terminal.storage import terminal as store'",
            "bash ~/terminal/scripts/restart.sh",
            "Verify https://terminal.summitflow.dev loads (curl with CF headers)",
            "Check journalctl --user -u summitflow-terminal for errors"
          ],
          "verification": "npm run build && python -c 'from terminal import main'"
        }
      ]
    }
  ]
}
