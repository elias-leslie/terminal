{
  "meta": {
    "title": "Full Codebase Refactor - Terminal Project",
    "created": "2026-01-01",
    "session_id": "refactor-20260101-092811",
    "project_id": "terminal",
    "baseline": {
      "targets": 6,
      "total_complexity": 37.16
    }
  },
  "phases": [
    {
      "id": 1,
      "name": "DRY Consolidation",
      "goal": "Eliminate code duplication identified across storage and frontend components",
      "tasks": [
        {
          "id": "1.1",
          "tier": 1,
          "model": "haiku",
          "parallelizable": true,
          "description": "Extract duplicated _to_str helper function",
          "files_affected": [
            "terminal/storage/terminal.py",
            "terminal/storage/terminal_claude.py",
            "terminal/storage/terminal_utils.py"
          ],
          "steps": [
            "Create terminal/storage/terminal_utils.py with _to_str function",
            "Update terminal/storage/terminal.py to import from terminal_utils",
            "Update terminal/storage/terminal_claude.py to import from terminal_utils",
            "Verify imports work: python -c \"from terminal.storage.terminal_utils import _to_str\""
          ],
          "verification": "python -c \"from terminal.storage.terminal_utils import _to_str; print('OK')\"",
          "passes": true
        },
        {
          "id": "1.2",
          "tier": 2,
          "model": "sonnet",
          "parallelizable": true,
          "description": "Extract query-fetch-convert pattern into helper function in terminal.py",
          "files_affected": [
            "terminal/storage/terminal.py"
          ],
          "steps": [
            "Add _execute_session_query helper function after TERMINAL_SESSION_FIELDS constant",
            "Refactor list_sessions to use _execute_session_query",
            "Refactor get_session to use _execute_session_query",
            "Refactor touch_session to use _execute_session_query",
            "Refactor list_orphaned to use _execute_session_query",
            "Refactor get_session_by_project to use _execute_session_query",
            "Refactor get_dead_session_by_project to use _execute_session_query",
            "Refactor get_project_sessions to use _execute_session_query",
            "Run backend service health check"
          ],
          "verification": "curl -s http://localhost:8002/health | grep -q ok",
          "passes": false
        },
        {
          "id": "1.3",
          "tier": 1,
          "model": "haiku",
          "parallelizable": true,
          "description": "Extract tab styling utility function in TabBar.tsx",
          "files_affected": [
            "frontend/components/TabBar.tsx"
          ],
          "steps": [
            "Add getTabClassName utility function at top of file",
            "Update project tab className to use utility",
            "Update ad-hoc tab className to use utility",
            "Verify no TypeScript errors: npx tsc --noEmit"
          ],
          "verification": "cd frontend && npx tsc --noEmit",
          "passes": true
        }
      ]
    },
    {
      "id": 2,
      "name": "Backend Modularization",
      "goal": "Split large backend files (>300 lines) by responsibility per architecture guidelines",
      "tasks": [
        {
          "id": "2.1",
          "tier": 2,
          "model": "sonnet",
          "parallelizable": false,
          "description": "Split lifecycle.py into core, batch, and reconcile modules",
          "files_affected": [
            "terminal/services/lifecycle.py",
            "terminal/services/lifecycle_core.py",
            "terminal/services/lifecycle_batch.py",
            "terminal/services/lifecycle_reconcile.py"
          ],
          "steps": [
            "Create lifecycle_core.py with: create_session, delete_session, ensure_session_alive, _kill_tmux_session, _resurrect_dead_session",
            "Create lifecycle_batch.py with: reset_session, reset_project_sessions, reset_all_sessions, disable_project_terminal",
            "Create lifecycle_reconcile.py with: reconcile_on_startup",
            "Update lifecycle.py to re-export from submodules for backward compatibility",
            "Verify imports: python -c \"from terminal.services.lifecycle import create_session, reset_all_sessions, reconcile_on_startup\"",
            "Restart backend service and verify health"
          ],
          "verification": "python -c \"from terminal.services.lifecycle import create_session, reset_all_sessions, reconcile_on_startup; print('OK')\" && curl -s http://localhost:8002/health | grep -q ok",
          "passes": false
        },
        {
          "id": "2.2",
          "tier": 2,
          "model": "sonnet",
          "parallelizable": false,
          "description": "Split terminal.py storage into crud, lifecycle, and project modules",
          "files_affected": [
            "terminal/storage/terminal.py",
            "terminal/storage/terminal_crud.py",
            "terminal/storage/terminal_lifecycle.py",
            "terminal/storage/terminal_project.py"
          ],
          "steps": [
            "Create terminal_crud.py with: list_sessions, get_session, create_session, update_session, delete_session, and shared utilities (_row_to_dict, TERMINAL_SESSION_FIELDS, _execute_session_query)",
            "Create terminal_lifecycle.py with: mark_dead, purge_dead_sessions, touch_session, list_orphaned",
            "Create terminal_project.py with: get_session_by_project, get_dead_session_by_project, get_project_sessions",
            "Update terminal.py to re-export from submodules for backward compatibility",
            "Verify imports: python -c \"from terminal.storage.terminal import list_sessions, mark_dead, get_project_sessions\"",
            "Restart backend service and verify health"
          ],
          "verification": "python -c \"from terminal.storage.terminal import list_sessions, mark_dead, get_project_sessions; print('OK')\" && curl -s http://localhost:8002/health | grep -q ok",
          "passes": false
        }
      ]
    },
    {
      "id": 3,
      "name": "Frontend Hook Extraction",
      "goal": "Extract reusable hooks from TerminalTabs.tsx to reduce complexity",
      "tasks": [
        {
          "id": "3.1",
          "tier": 2,
          "model": "sonnet",
          "parallelizable": true,
          "description": "Create useLocalStorageState hook and apply to keyboard size management",
          "files_affected": [
            "frontend/lib/hooks/use-local-storage-state.ts",
            "frontend/components/TerminalTabs.tsx"
          ],
          "steps": [
            "Create frontend/lib/hooks/use-local-storage-state.ts with generic useLocalStorageState<T>(key, defaultValue) hook",
            "Update TerminalTabs.tsx to use useLocalStorageState for keyboardSize state",
            "Remove manual localStorage useEffect for loading keyboard size",
            "Update handleKeyboardSizeChange to use hook's setter directly",
            "Verify no TypeScript errors: npx tsc --noEmit"
          ],
          "verification": "cd frontend && npx tsc --noEmit",
          "passes": false
        },
        {
          "id": "3.2",
          "tier": 2,
          "model": "sonnet",
          "parallelizable": true,
          "description": "Extract getNextTerminalName utility to session.ts",
          "files_affected": [
            "frontend/lib/utils/session.ts",
            "frontend/components/TerminalTabs.tsx"
          ],
          "steps": [
            "Move getNextTerminalName function from TerminalTabs.tsx to frontend/lib/utils/session.ts",
            "Export getNextTerminalName from session.ts",
            "Update TerminalTabs.tsx to import getNextTerminalName from session.ts",
            "Verify no TypeScript errors: npx tsc --noEmit"
          ],
          "verification": "cd frontend && npx tsc --noEmit",
          "passes": false
        },
        {
          "id": "3.3",
          "tier": 2,
          "model": "sonnet",
          "parallelizable": true,
          "description": "Extract mouse event handling from Terminal.tsx into useTerminalMouseHandling hook",
          "files_affected": [
            "frontend/lib/hooks/use-terminal-mouse-handling.ts",
            "frontend/components/Terminal.tsx"
          ],
          "steps": [
            "Create frontend/lib/hooks/use-terminal-mouse-handling.ts with forceLocalMouseHandling logic",
            "Export setupMouseHandling function that returns cleanup function",
            "Update Terminal.tsx to import and use the hook in initialization effect",
            "Verify no TypeScript errors: npx tsc --noEmit"
          ],
          "verification": "cd frontend && npx tsc --noEmit",
          "passes": false
        }
      ]
    },
    {
      "id": 4,
      "name": "Component Decomposition",
      "goal": "Extract sub-components from TabBar to reduce prop drilling and complexity",
      "tasks": [
        {
          "id": "4.1",
          "tier": 2,
          "model": "sonnet",
          "parallelizable": true,
          "description": "Extract ProjectTab sub-component from TabBar.tsx",
          "files_affected": [
            "frontend/components/TabBar.tsx",
            "frontend/components/ProjectTab.tsx"
          ],
          "steps": [
            "Create frontend/components/ProjectTab.tsx with project tab rendering logic (lines 142-199)",
            "Define ProjectTabProps interface with required props",
            "Update TabBar.tsx to import and use ProjectTab component",
            "Verify no TypeScript errors: npx tsc --noEmit"
          ],
          "verification": "cd frontend && npx tsc --noEmit",
          "passes": false
        },
        {
          "id": "4.2",
          "tier": 2,
          "model": "sonnet",
          "parallelizable": true,
          "description": "Extract AdHocTab sub-component from TabBar.tsx",
          "files_affected": [
            "frontend/components/TabBar.tsx",
            "frontend/components/AdHocTab.tsx"
          ],
          "steps": [
            "Create frontend/components/AdHocTab.tsx with ad-hoc tab rendering logic (lines 210-287)",
            "Define AdHocTabProps interface with required props",
            "Update TabBar.tsx to import and use AdHocTab component",
            "Verify no TypeScript errors: npx tsc --noEmit"
          ],
          "verification": "cd frontend && npx tsc --noEmit",
          "passes": false
        }
      ]
    },
    {
      "id": 5,
      "name": "Final Verification",
      "goal": "Verify all changes work correctly together",
      "tasks": [
        {
          "id": "5.1",
          "tier": 1,
          "model": "haiku",
          "parallelizable": false,
          "description": "Run full backend verification",
          "files_affected": [],
          "steps": [
            "Restart backend service: systemctl --user restart summitflow-terminal",
            "Wait for service to start: sleep 3",
            "Verify health endpoint: curl -s http://localhost:8002/health",
            "Verify sessions endpoint: curl -s http://localhost:8002/api/terminal/sessions"
          ],
          "verification": "curl -s http://localhost:8002/health | grep -q ok",
          "passes": false
        },
        {
          "id": "5.2",
          "tier": 1,
          "model": "haiku",
          "parallelizable": false,
          "description": "Run full frontend verification",
          "files_affected": [],
          "steps": [
            "Run TypeScript type check: cd frontend && npx tsc --noEmit",
            "Run ESLint: cd frontend && npm run lint",
            "Run frontend build: cd frontend && npm run build"
          ],
          "verification": "cd frontend && npm run build",
          "passes": false
        }
      ]
    }
  ]
}
