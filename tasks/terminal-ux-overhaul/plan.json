{
  "title": "Terminal UX Overhaul: Eliminate Copy-Mode, Fix Performance, Restore Project Selection",
  "objective": "Transform terminal scrolling from clunky tmux copy-mode to native xterm.js scrolling via history hydration, add output throttling for performance, fix environment security, and restore broken project pane creation.",
  "spirit": "Ghostty-like smooth scrolling with zero network latency, combined with robust tmux persistence. User should never see or enter copy-mode again.",
  "spirit_anti": "Do NOT remove tmux persistence. Do NOT break existing session management. Do NOT over-engineer - focus on the specific improvements.",
  "done_when": [
    "Scrolling works natively in xterm.js without entering tmux copy-mode",
    "vim/less/htop scroll via arrow keys (alternate screen detection)",
    "Heavy output (cat large_file) doesn't freeze browser",
    "Project terminal panes can be created via + button again",
    "Child shells don't inherit DATABASE_URL and other secrets"
  ],
  "decisions": [
    {
      "id": "d1",
      "title": "Scrollback sync method",
      "question": "How to sync tmux scrollback to xterm.js?",
      "outcome": "History hydration: on WebSocket connect, run `tmux capture-pane -S - -e -J -p` and write to xterm.js before piping live output"
    },
    {
      "id": "d2",
      "title": "Alternate screen detection",
      "question": "How to detect vim/less running?",
      "outcome": "Client-side via term.buffer.active.type === 'alternate'"
    },
    {
      "id": "d3",
      "title": "Output throttling config",
      "question": "Output throttling parameters?",
      "outcome": "16ms flush interval, 4KB batch size (from ghostty/AutoMaker analysis)"
    }
  ],
  "constraints": [
    "Must preserve tmux session persistence (survives server restarts)",
    "Must not break existing WebSocket protocol",
    "Must work on both desktop and mobile"
  ],
  "subtasks": [
    {
      "id": "1.1",
      "title": "Fix httpcore dependency for project API",
      "description": "Install missing httpcore dependency that broke /api/terminal/projects endpoint. Run `pip install httpcore` or add to pyproject.toml and reinstall.",
      "steps": [
        "Add httpcore to pyproject.toml dependencies",
        "Run pip install in terminal venv",
        "Restart summitflow-terminal service",
        "Verify /api/terminal/projects returns project list"
      ],
      "acceptance_criteria": [
        {
          "criterion": "GET /api/terminal/projects returns non-empty list of projects",
          "verify_by": "test",
          "verify_command": "curl -s http://localhost:8002/api/terminal/projects | jq 'length > 0'"
        },
        {
          "criterion": "Terminal Manager Modal shows projects when + button clicked",
          "verify_by": "human"
        }
      ]
    },
    {
      "id": "1.2",
      "title": "Implement history hydration on WebSocket connect",
      "description": "On WebSocket connect, capture tmux scrollback and send to client before piping live output. This enables native xterm.js scrolling.",
      "steps": [
        "Add get_scrollback() function using tmux capture-pane -S - -e -J -p",
        "Wait for first resize event from frontend (sync dimensions)",
        "Run tmux resize-window to match frontend dimensions",
        "Capture scrollback and send to WebSocket",
        "Then begin piping live PTY output"
      ],
      "acceptance_criteria": [
        {
          "criterion": "On reconnect, terminal shows previous output history",
          "verify_by": "human"
        },
        {
          "criterion": "Scrollback is properly formatted (no width mismatch)",
          "verify_by": "human"
        }
      ]
    },
    {
      "id": "1.3",
      "title": "Implement alternate screen detection for desktop wheel AND mobile touch",
      "description": "Replace tmux copy-mode scrolling with native xterm.js scrolling for both desktop and mobile. Detect alternate screen (vim/less) and send arrow keys instead.",
      "steps": [
        "Delete use-terminal-scrolling.ts (copy-mode logic)",
        "DESKTOP: Add wheel event handler to Terminal.tsx",
        "MOBILE: Add touch scroll handler to Terminal.tsx",
        "Check term.buffer.active.type for alternate screen",
        "If normal mode: let xterm.js handle scroll natively (both wheel and touch)",
        "If alternate mode: send arrow key sequences (\\x1bOA/\\x1bOB) for both wheel and touch",
        "Remove copy-mode imports and state from Terminal.tsx",
        "Test scrolling on desktop with mouse wheel",
        "Test scrolling on mobile with touch gestures"
      ],
      "acceptance_criteria": [
        {
          "criterion": "Desktop: Mouse wheel scrolls terminal history without entering copy-mode",
          "verify_by": "human"
        },
        {
          "criterion": "Desktop: Mouse wheel in vim/less scrolls the application (sends arrow keys)",
          "verify_by": "human"
        },
        {
          "criterion": "Mobile: Touch scroll works in terminal history without entering copy-mode",
          "verify_by": "human"
        },
        {
          "criterion": "Mobile: Touch scroll in vim/less scrolls the application (sends arrow keys)",
          "verify_by": "human"
        },
        {
          "criterion": "use-terminal-scrolling.ts file is deleted",
          "verify_by": "test",
          "verify_command": "test ! -f frontend/lib/hooks/use-terminal-scrolling.ts && echo true"
        }
      ]
    },
    {
      "id": "1.4",
      "title": "Add output throttling to PTY reader",
      "description": "Implement 16ms/4KB batching in read_pty_output to prevent browser freeze on heavy output.",
      "steps": [
        "Modify read_pty_output in pty_manager.py",
        "Add buffer accumulation with 16ms flush interval",
        "Add 4KB batch size limit per flush",
        "Ensure buffer is flushed on disconnect"
      ],
      "acceptance_criteria": [
        {
          "criterion": "Running 'cat large_file.log' doesn't freeze browser UI",
          "verify_by": "human"
        },
        {
          "criterion": "Normal typing remains responsive (no input lag)",
          "verify_by": "human"
        }
      ]
    },
    {
      "id": "1.5",
      "title": "Add frontend resize debounce",
      "description": "Add 150ms debounce before sending resize events to backend to prevent prompt duplication.",
      "steps": [
        "Modify resize handler in Terminal.tsx",
        "Add 150ms debounce before sending resize JSON to WebSocket",
        "Ensure debounce is cleared on unmount"
      ],
      "acceptance_criteria": [
        {
          "criterion": "Resizing terminal window doesn't cause prompt duplication",
          "verify_by": "human"
        }
      ]
    },
    {
      "id": "1.6",
      "title": "Scrub sensitive environment variables from child shells",
      "description": "Filter DATABASE_URL and other secrets from environment before spawning tmux session.",
      "steps": [
        "Identify env vars to filter: DATABASE_URL, API keys, etc.",
        "Modify tmux session spawn in lifecycle_core.py or tmux.py",
        "Create explicit allowlist of safe env vars",
        "Verify child shells don't have access to secrets"
      ],
      "acceptance_criteria": [
        {
          "criterion": "echo $DATABASE_URL in terminal returns empty",
          "verify_by": "human"
        },
        {
          "criterion": "Basic shell functionality still works (PATH, HOME, TERM preserved)",
          "verify_by": "human"
        }
      ]
    },
    {
      "id": "1.7",
      "title": "Match xterm.js scrollback to tmux history limit",
      "description": "Configure xterm.js scrollback buffer to match tmux history-limit for consistency.",
      "steps": [
        "Check tmux history-limit setting",
        "Update SCROLLBACK constant in terminal constants",
        "Ensure xterm.js Terminal options use matching value"
      ],
      "acceptance_criteria": [
        {
          "criterion": "xterm.js scrollback matches tmux history-limit (10000 lines)",
          "verify_by": "test",
          "verify_command": "grep -r 'scrollback.*10000' frontend/lib/constants/"
        }
      ]
    },
    {
      "id": "1.8",
      "title": "Full UI/UX testing and polish for desktop AND mobile",
      "description": "Comprehensive UI/UX audit and testing for both desktop and mobile viewports. Use browser-automation for screenshots with different viewport sizes. Use frontend-design skill for design review. Focus on clean, minimalistic design.",
      "steps": [
        "DESKTOP TESTING (1920x1080 viewport):",
        "Screenshot: empty state (no terminals open)",
        "Screenshot: single terminal with shell prompt",
        "Screenshot: Terminal Manager Modal open with projects listed",
        "Screenshot: terminal with scrollback content visible",
        "Screenshot: terminal header controls and + button",
        "Test mouse wheel scrolling in normal shell mode",
        "Test mouse wheel scrolling in vim/less (alternate screen)",
        "MOBILE TESTING (390x844 viewport - iPhone 14):",
        "Screenshot: mobile terminal view",
        "Screenshot: mobile Terminal Manager Modal",
        "Screenshot: mobile keyboard overlay",
        "Test touch scrolling behavior",
        "Verify mobile keyboard input works correctly",
        "Verify touch targets are appropriately sized (min 44px)",
        "DESIGN REVIEW:",
        "Invoke frontend-design skill for design audit on all screenshots",
        "Review scrollbar appearance, visibility, and thumb styling",
        "Check terminal header controls spacing, alignment, and hover states",
        "Verify Terminal Manager Modal styling consistency with terminal theme",
        "Test all interactive elements: + button, mode toggle, action menus",
        "Verify 0 console errors during all UI interactions (desktop and mobile)",
        "POLISH:",
        "Fix any issues identified in desktop or mobile testing",
        "Ensure responsive design works across viewport sizes",
        "Ensure design remains clean and minimalistic throughout"
      ],
      "acceptance_criteria": [
        {
          "criterion": "Desktop screenshots captured for all key UI states",
          "verify_by": "human"
        },
        {
          "criterion": "Mobile screenshots captured for all key UI states",
          "verify_by": "human"
        },
        {
          "criterion": "Frontend-design skill audit completed with no critical issues",
          "verify_by": "human"
        },
        {
          "criterion": "Zero console errors on desktop viewport",
          "verify_by": "test",
          "verify_command": "ba check http://localhost:3002 --no-errors -o /tmp/terminal-desktop-check"
        },
        {
          "criterion": "Zero console errors on mobile viewport",
          "verify_by": "test",
          "verify_command": "ba check http://localhost:3002 --no-errors --viewport 390x844 -o /tmp/terminal-mobile-check"
        },
        {
          "criterion": "Terminal UI is clean and minimalistic on both desktop and mobile",
          "verify_by": "human"
        }
      ]
    },
    {
      "id": "1.9",
      "title": "Verify and test complete implementation",
      "description": "Run full test suite and manual verification of all changes.",
      "steps": [
        "Run backend pytest",
        "Run frontend tests",
        "Manual test: scroll in normal shell",
        "Manual test: scroll in vim",
        "Manual test: cat large file",
        "Manual test: add project terminal via + button",
        "Manual test: resize terminal window"
      ],
      "acceptance_criteria": [
        {
          "criterion": "All backend tests pass",
          "verify_by": "test",
          "verify_command": "./scripts/dev-tools.sh pytest"
        },
        {
          "criterion": "All frontend tests pass",
          "verify_by": "test",
          "verify_command": "cd frontend && npm test -- --run"
        }
      ]
    }
  ],
  "acceptance_criteria": [
    {
      "id": "ac-1",
      "criterion": "Copy-mode is never entered during normal scrolling",
      "verify_by": "human"
    },
    {
      "id": "ac-2",
      "criterion": "Terminal history is visible on reconnect",
      "verify_by": "human"
    },
    {
      "id": "ac-3",
      "criterion": "Project panes can be created via + button",
      "verify_by": "human"
    },
    {
      "id": "ac-4",
      "criterion": "Heavy output doesn't freeze browser",
      "verify_by": "human"
    },
    {
      "id": "ac-5",
      "criterion": "Secrets are not exposed in child shell",
      "verify_by": "human"
    }
  ],
  "files_to_modify": [
    "pyproject.toml",
    "terminal/api/terminal.py",
    "terminal/services/pty_manager.py",
    "terminal/services/lifecycle_core.py",
    "terminal/utils/tmux.py",
    "frontend/components/Terminal.tsx",
    "frontend/lib/hooks/use-terminal-scrolling.ts (DELETE)",
    "frontend/lib/constants/terminal.ts"
  ],
  "complexity": "COMPLEX",
  "source_analysis": [
    "AutoMaker terminal: output throttling 4ms/4KB, env scrubbing",
    "ghostty-web: viewportY scrolling, alternate screen detection, smooth scroll",
    "ghostty native: page-based scrollback, dirty tracking, 120fps render",
    "Gemini consultation: history hydration architecture, capture-pane -J flag"
  ]
}
