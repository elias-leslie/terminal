{
  "title": "Remove Single Mode and Add Resizable Dynamic Pane Grid",
  "objective": "Replace the current single/grid mode toggle with a unified dynamic resizable pane system where layout auto-adapts based on pane count and user arrangement, all controls live in minimalistic pane headers, and pane sizes persist to backend.",
  "complexity": "COMPLEX",
  "done_when": [
    "Single mode completely removed from codebase",
    "Dynamic resizable pane grid working with 1-4 panes",
    "All controls accessible from pane headers (no main header bar)",
    "Pane sizes persist to backend and survive refresh",
    "Browser automation tests pass with no console errors"
  ],
  "spirit_anti": "Do NOT add a main window header bar - all controls must be in pane headers only. Do NOT add keyboard shortcuts. Do NOT add per-project layouts. Do NOT use dnd-kit - react-resizable-panels handles everything.",

  "acceptance_criteria": [
    {
      "id": "ac-1",
      "criterion": "Single mode is completely removed - no single mode option exists in UI or code",
      "category": "correctness",
      "verify_command": "grep -r 'single' frontend/components/LayoutModeButton.tsx frontend/lib/constants/terminal.ts 2>/dev/null | grep -v 'single-line' | wc -l",
      "expected_output": "Exit code 0, output is 0 (no matches)",
      "verify_by": "test"
    },
    {
      "id": "ac-2",
      "criterion": "Dynamic grid adapts: 1 pane=full, 2 panes=vertical split, 3 panes=2+1, 4 panes=2x2",
      "category": "correctness",
      "verify_command": "cd frontend && npm run build 2>&1 | tail -5",
      "expected_output": "Exit code 0, build succeeds",
      "verify_by": "test"
    },
    {
      "id": "ac-3",
      "criterion": "Panes are resizable by dragging dividers between them",
      "category": "correctness",
      "verify_command": "grep -r 'react-resizable-panels' frontend/package.json",
      "expected_output": "Package is listed in dependencies",
      "verify_by": "test"
    },
    {
      "id": "ac-4",
      "criterion": "Pane sizes persist to backend and survive browser refresh",
      "category": "correctness",
      "verify_command": "grep -r 'width_percent\\|height_percent' terminal/storage/terminal.py",
      "expected_output": "Layout fields present in storage module",
      "verify_by": "test"
    },
    {
      "id": "ac-5",
      "criterion": "All controls accessible from each pane header (no main header bar exists)",
      "category": "quality",
      "verify_command": "ba check http://localhost:3002 --no-errors -o /tmp/verify-panes",
      "expected_output": "Screenshot shows pane headers with all controls: drag handle, mode toggle, name, +, upload, settings, reset, close, overflow menu. No main header bar visible.",
      "verify_by": "agent"
    },
    {
      "id": "ac-6",
      "criterion": "When all panes deleted, an ad-hoc pane is auto-created taking full view",
      "category": "correctness",
      "verify_command": "ba check http://localhost:3002 --no-errors -o /tmp/verify-auto-create",
      "expected_output": "After deleting all panes, a single full-screen ad-hoc terminal pane appears automatically",
      "verify_by": "agent"
    },
    {
      "id": "ac-7",
      "criterion": "Dividers show subtle line normally, 4px handle with accent color on hover",
      "category": "quality",
      "verify_command": "ba check http://localhost:3002 --no-errors -o /tmp/verify-dividers",
      "expected_output": "With 2+ panes, dividers are subtle 1px lines. On hover, they become 4px with accent color.",
      "verify_by": "agent"
    },
    {
      "id": "ac-8",
      "criterion": "Terminal content resizes only after drag ends (no flicker during drag)",
      "category": "quality",
      "verify_command": "grep -r 'onLayout' frontend/components/ | head -5",
      "expected_output": "onLayout callback wired to trigger terminal resize on layout change completion",
      "verify_by": "test"
    },
    {
      "id": "ac-9",
      "criterion": "Double-clicking a divider resets adjacent panes to equal sizes",
      "category": "correctness",
      "verify_command": "grep -r 'onDoubleClick\\|resetSize' frontend/components/",
      "expected_output": "Double-click handler present that resets panel sizes",
      "verify_by": "test"
    },
    {
      "id": "ac-10",
      "criterion": "Minimum pane size of 400x300px enforced, scrollbars appear if window too small",
      "category": "quality",
      "verify_command": "grep -r 'minSize\\|MIN_PANE' frontend/",
      "expected_output": "Minimum size constants defined and used in panel configuration",
      "verify_by": "test"
    },
    {
      "id": "ac-11",
      "criterion": "No console errors during normal operation",
      "category": "quality",
      "verify_command": "ba check http://localhost:3002 --no-errors",
      "expected_output": "Exit code 0, no console errors",
      "verify_by": "test"
    },
    {
      "id": "ac-12",
      "criterion": "TypeScript compiles without errors",
      "category": "correctness",
      "verify_command": "cd frontend && npm run typecheck 2>&1 | tail -5",
      "expected_output": "Exit code 0, no type errors",
      "verify_by": "test"
    }
  ],

  "decisions": [
    {
      "id": "d1",
      "title": "Layout library choice",
      "outcome": "Use react-resizable-panels for both resize AND reorder functionality",
      "rationale": "Single library for consistent behavior. Replaces dnd-kit. Mature, used by VS Code web."
    },
    {
      "id": "d2",
      "title": "Dynamic grid adaptation",
      "outcome": "1 pane=full, 2 panes=vertical split (side by side), 3 panes=2+1 based on drag arrangement, 4 panes=2x2",
      "rationale": "Maximizes vertical terminal real estate. Terminals benefit from height more than width."
    },
    {
      "id": "d3",
      "title": "Header architecture",
      "outcome": "No main window header bar. All controls in individual pane headers (32px height)",
      "rationale": "User requirement: maximize usable terminal space while maintaining all functionality."
    },
    {
      "id": "d4",
      "title": "Persistence strategy",
      "outcome": "Store layout globally (not per-project) with percentage-based sizing for future scalability",
      "rationale": "Simpler model. Percentages adapt to different screen sizes and future grid expansions."
    },
    {
      "id": "d5",
      "title": "Divider styling",
      "outcome": "1px subtle line normally, 4px visible handle with accent color on hover",
      "rationale": "Minimalistic but discoverable. Matches overall terminal aesthetic."
    },
    {
      "id": "d6",
      "title": "Terminal resize timing",
      "outcome": "Resize terminal content only after drag ends",
      "rationale": "Prevents flicker during drag. Better UX with standard behavior."
    },
    {
      "id": "d7",
      "title": "Pane deletion behavior",
      "outcome": "Smart collapse: adjacent panes expand automatically. Prefer vertical layouts. Auto-create ad-hoc pane when all deleted.",
      "rationale": "Seamless experience. Never leaves user stranded with empty view."
    },
    {
      "id": "d8",
      "title": "Global actions placement",
      "outcome": "Add overflow menu (...) to each pane header containing Reset All, Close All",
      "rationale": "Since no main header exists, global actions must be accessible from any pane."
    }
  ],

  "constraints": [
    "Maximum 4 panes for now (2x2 max)",
    "Minimum pane size: 400x300px",
    "No keyboard shortcuts in this iteration",
    "No per-project layout storage",
    "Must maintain mobile support (existing MobileKeyboard integration)",
    "Backend persistence required - not localStorage only"
  ],

  "subtasks": [
    {
      "id": "1.1",
      "phase": "backend",
      "description": "Add layout fields to terminal_panes database table",
      "steps": [
        "Add migration for terminal_panes: width_percent FLOAT, height_percent FLOAT, grid_row INT, grid_col INT",
        "Update terminal/storage/terminal.py with new fields in TerminalPane model",
        "Update create/update pane functions to handle layout fields",
        "Verify migration runs: source ~/.env.local && psql $DATABASE_URL -c '\\d terminal_panes'"
      ],
      "depends_on": []
    },
    {
      "id": "1.2",
      "phase": "backend",
      "description": "Add API endpoints for layout persistence",
      "steps": [
        "Add PATCH /api/terminal/panes/{id}/layout endpoint accepting width_percent, height_percent, grid_row, grid_col",
        "Add PUT /api/terminal/layout endpoint for bulk layout updates (all panes at once)",
        "Update GET /api/terminal/panes to return layout fields",
        "Add retry logic to layout save operations"
      ],
      "depends_on": ["1.1"]
    },
    {
      "id": "2.1",
      "phase": "frontend",
      "description": "Remove dnd-kit (react-resizable-panels already installed)",
      "steps": [
        "Verify react-resizable-panels already in package.json (already installed v4.2.0)",
        "Run: cd frontend && npm uninstall @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities",
        "Remove dnd-kit imports from GridLayout.tsx",
        "Verify build still works: npm run build"
      ],
      "depends_on": []
    },
    {
      "id": "2.2",
      "phase": "frontend",
      "description": "Remove single mode and related code",
      "steps": [
        "Remove 'single' from LayoutMode type in LayoutModeButton.tsx",
        "Remove SingleModeTerminals.tsx component entirely",
        "Remove single mode branch from TerminalLayoutRenderer.tsx",
        "Remove TerminalHeader.tsx (single mode header) entirely",
        "Update TerminalTabs.tsx to remove single mode conditional rendering",
        "Remove 'single' from LAYOUT_OPTIONS in LayoutModeButton.tsx",
        "Update use-available-layouts.ts to remove single mode",
        "Run typecheck: npm run typecheck"
      ],
      "depends_on": ["2.1"]
    },
    {
      "id": "2.3",
      "phase": "frontend",
      "description": "Create new ResizablePaneLayout component using react-resizable-panels",
      "steps": [
        "Create frontend/components/ResizablePaneLayout.tsx",
        "Import PanelGroup, Panel, PanelResizeHandle from react-resizable-panels",
        "Implement dynamic layout: compute Panel arrangement based on pane count",
        "For 1 pane: single full-size Panel",
        "For 2 panes: horizontal PanelGroup with 2 Panels (vertical split)",
        "For 3 panes: nested PanelGroups - either 2+1 horizontal or 1+2 vertical based on stored layout",
        "For 4 panes: 2x2 grid using nested PanelGroups",
        "Add minSize constraints (400x300px converted to percentage based on container)",
        "Wire onLayout callback to trigger terminal resize after drag ends"
      ],
      "depends_on": ["2.2"]
    },
    {
      "id": "2.4",
      "phase": "frontend",
      "description": "Implement resizable divider styling",
      "steps": [
        "Create custom PanelResizeHandle component with hover state",
        "Default: 1px solid var(--term-border)",
        "Hover: 4px with var(--term-accent) background",
        "Add cursor: col-resize (vertical) or cursor: row-resize (horizontal)",
        "Add onDoubleClick handler to reset adjacent panels to 50/50"
      ],
      "depends_on": ["2.3"]
    },
    {
      "id": "2.5",
      "phase": "frontend",
      "description": "Update UnifiedTerminalHeader with overflow menu",
      "steps": [
        "Add overflow menu button (...) to UnifiedTerminalHeader",
        "Create PaneOverflowMenu.tsx with Reset All, Close All options",
        "Ensure all existing controls remain: drag handle, mode toggle, name/swap, +, clean, upload, settings, reset, close",
        "Remove layout selector from pane headers (no longer needed - single mode gone)",
        "Verify header height remains 32px"
      ],
      "depends_on": ["2.2"]
    },
    {
      "id": "2.6",
      "phase": "frontend",
      "description": "Implement drag-to-rearrange with drop zone indicators",
      "steps": [
        "Add drag handle to each pane that initiates reorder",
        "Show drop zone indicators when dragging: highlight edges for drop targets",
        "Implement layout recalculation on drop: determine new grid_row, grid_col for each pane",
        "For 3-pane: dropping on horizontal edge = 2+1 horizontal, vertical edge = 2+1 vertical",
        "Persist new layout to backend via PUT /api/terminal/layout"
      ],
      "depends_on": ["2.3", "2.4"]
    },
    {
      "id": "2.7",
      "phase": "frontend",
      "description": "Implement smart pane collapse on delete",
      "steps": [
        "Update handleSlotClose to recalculate layout after pane removal",
        "For 4->3 panes: adjacent pane expands to fill gap",
        "For 3->2 panes: if deleting solo pane, remaining 2 become vertical split",
        "For 2->1 pane: remaining pane takes full view",
        "For 1->0 panes: auto-create ad-hoc pane taking full view",
        "Persist updated layout to backend"
      ],
      "depends_on": ["2.3", "2.6"]
    },
    {
      "id": "2.8",
      "phase": "frontend",
      "description": "Wire layout persistence to backend",
      "steps": [
        "Create useLayoutPersistence hook for debounced layout saves",
        "On resize end: save updated percentages to backend",
        "On reorder: save updated positions to backend",
        "Implement silent retry (3 attempts) with toast on failure",
        "Load saved layout on initial render from GET /api/terminal/panes"
      ],
      "depends_on": ["1.2", "2.3"]
    },
    {
      "id": "2.9",
      "phase": "frontend",
      "description": "Update TerminalLayoutRenderer to use new ResizablePaneLayout",
      "steps": [
        "Replace GridLayout usage with ResizablePaneLayout",
        "Remove isGridMode checks (everything is now grid/resizable)",
        "Pass terminal slots, layout state, and callbacks to ResizablePaneLayout",
        "Ensure terminal resize is triggered via onLayout after panel resize"
      ],
      "depends_on": ["2.3", "2.5"]
    },
    {
      "id": "2.10",
      "phase": "frontend",
      "description": "Clean up obsolete components and imports",
      "steps": [
        "Delete frontend/components/GridLayout.tsx (replaced by ResizablePaneLayout)",
        "Delete frontend/components/GridCell.tsx (merged into ResizablePaneLayout)",
        "Delete frontend/components/TerminalHeader.tsx (single mode header)",
        "Delete frontend/components/SingleModeTerminals.tsx",
        "Remove unused imports from TerminalTabs.tsx",
        "Update barrel exports if any",
        "Run: npm run typecheck && npm run build"
      ],
      "depends_on": ["2.9"]
    },
    {
      "id": "3.1",
      "phase": "verification",
      "description": "Visual verification of pane layouts",
      "steps": [
        "Start services: bash ~/terminal/scripts/restart.sh",
        "Wait 5 seconds for services to start",
        "ba check http://localhost:3002 --no-errors -o /tmp/verify-1pane",
        "Read /tmp/verify-1pane/*.png - verify single pane takes full view, pane header visible with all controls",
        "Create second pane via + button",
        "ba check http://localhost:3002 --no-errors -o /tmp/verify-2pane",
        "Read /tmp/verify-2pane/*.png - verify 2 panes side by side (vertical split)",
        "Create third and fourth panes",
        "ba check http://localhost:3002 --no-errors -o /tmp/verify-4pane",
        "Read /tmp/verify-4pane/*.png - verify 2x2 grid layout"
      ],
      "depends_on": ["2.10"]
    },
    {
      "id": "3.2",
      "phase": "verification",
      "description": "Verify resize functionality",
      "steps": [
        "With 2+ panes open, hover over divider",
        "ba check http://localhost:3002 -o /tmp/verify-divider-hover",
        "Read screenshot - verify divider shows 4px handle with accent color",
        "Drag divider to resize panes",
        "ba check http://localhost:3002 --no-errors -o /tmp/verify-resized",
        "Read screenshot - verify panes have different sizes",
        "Refresh browser",
        "ba check http://localhost:3002 --no-errors -o /tmp/verify-persisted",
        "Read screenshot - verify custom sizes persisted after refresh"
      ],
      "depends_on": ["3.1"]
    },
    {
      "id": "3.3",
      "phase": "verification",
      "description": "Verify pane deletion and auto-create behavior",
      "steps": [
        "Close all panes except one",
        "Close the last pane",
        "ba check http://localhost:3002 --no-errors -o /tmp/verify-auto-create",
        "Read screenshot - verify ad-hoc pane auto-created taking full view",
        "Verify pane header has all controls accessible"
      ],
      "depends_on": ["3.1"]
    },
    {
      "id": "3.4",
      "phase": "verification",
      "description": "UI/UX end-to-end verification",
      "steps": [
        "Restart frontend: systemctl --user restart summitflow-terminal-frontend",
        "Wait 5 seconds",
        "ba check http://localhost:3002 --no-errors -o /tmp/final",
        "Read /tmp/final/*.png",
        "Invoke design-verify skill to assess: no main header bar, pane headers compact (32px), controls accessible, dividers subtle",
        "Test complete user flow: create panes, resize, delete, verify persistence",
        "Confirm terminals are functional and receive input correctly"
      ],
      "depends_on": ["3.3"]
    }
  ],

  "context": {
    "relevant_files": [
      "frontend/components/TerminalTabs.tsx",
      "frontend/components/TerminalLayoutRenderer.tsx",
      "frontend/components/GridLayout.tsx",
      "frontend/components/GridCell.tsx",
      "frontend/components/UnifiedTerminalHeader.tsx",
      "frontend/components/TerminalHeader.tsx",
      "frontend/components/SingleModeTerminals.tsx",
      "frontend/components/LayoutModeButton.tsx",
      "frontend/lib/hooks/use-terminal-tabs-state.ts",
      "frontend/lib/hooks/use-terminal-panes.ts",
      "frontend/lib/constants/terminal.ts",
      "terminal/storage/terminal.py",
      "terminal/api/sessions.py"
    ],
    "patterns": [
      "Use react-resizable-panels PanelGroup/Panel/PanelResizeHandle components",
      "Persist layout as percentages for screen-size independence",
      "Trigger terminal resize via onLayout callback after drag ends",
      "Use overflow menu for less common actions to keep header compact"
    ],
    "gotchas": [
      "react-resizable-panels expects percentage-based sizing, not pixels",
      "PanelResizeHandle needs custom styling to match terminal aesthetic",
      "Must handle minimum size constraints to prevent panels from collapsing",
      "Terminal.tsx ResizeObserver will handle terminal content resize",
      "dnd-kit removal may break existing drag handlers - ensure complete removal"
    ],
    "design_direction": "Minimalistic terminal aesthetic. Dark theme with subtle borders. Accent color on interactive elements. Maximum terminal space, compact controls. No unnecessary chrome."
  }
}
